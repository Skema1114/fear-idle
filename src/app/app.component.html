<div class="header">
  <span class="essence-display"
    >ğŸ•¯ï¸ EssÃªncia:
    <span class="value">{{ formatNumber(darkEssence()) }}</span></span
  >
  <span class="essence-display"
    >ğŸ’° Total:
    <span class="value">{{ formatNumber(totalEssence()) }}</span></span
  >
  <span class="essence-display"
    >âš¡ Por segundo:
    <span class="value">{{
      formatNumber(essencePerSecond(), true)
    }}</span></span
  >
</div>

<div class="game-container">
  <div class="intro-section">
    <h1>ğŸ•¯ï¸ Culto das Sombras</h1>
    <p class="intro-animation">As trevas estÃ£o despertando...</p>
  </div>

  <div class="current-stats">
    <p>
      <strong>EssÃªncia Atual:</strong>
      <span class="value">{{ formatNumber(darkEssence()) }}</span>
    </p>
    <p>
      <strong>EssÃªncia Total:</strong>
      <span class="value">{{ formatNumber(totalEssence()) }}</span>
    </p>
    <p>
      <strong>Ganho por segundo:</strong>
      <span class="value">{{ formatNumber(essencePerSecond(), true) }}</span>
    </p>
  </div>

  <div class="actions-section">
    <button class="primary-button click-button" (click)="manualClick()">
      Canalizar EssÃªncia Manualmente <br />
      (+{{ formatNumber(baseClickValue() * comboMultiplier(), true) }} EssÃªncia
      / Clique)
    </button>

    <div class="combo-display" *ngIf="comboCount() > 0">
      <span>COMBO: {{ formatNumber(comboCount()) }}x</span>
      <span>Multiplicador: x{{ formatNumber(comboMultiplier(), true) }}</span>
    </div>

    <div class="purchase-modes-group">
      <label *ngFor="let mode of numericPurchaseModes" class="radio-label">
        <input
          type="radio"
          name="purchase"
          [value]="mode"
          [(ngModel)]="currentPurchaseMode"
        />
        {{ mode }}x
      </label>
      <label class="radio-label">
        <input
          type="radio"
          name="purchase"
          value="max"
          [(ngModel)]="currentPurchaseMode"
        />
        MAX
      </label>
    </div>
  </div>

  <div class="save-export-section">
    <button class="secondary-button" (click)="saveGameManually()">
      Salvar Jogo Manualmente
    </button>
    <button class="secondary-button" (click)="exportSave()">
      Exportar Save
    </button>
    <button class="secondary-button" (click)="showImportModal = true">
      Importar Save
    </button>
  </div>

  <h2 class="section-title">ğŸ”® ManifestaÃ§Ãµes AutomÃ¡ticas</h2>
  <ng-container *ngIf="unlockedUpgrades().length > 0; else noUpgradesAvailable">
    <div class="upgrades-grid">
      <div
        class="upgrade-card"
        *ngFor="
          let up of unlockedUpgrades();
          trackBy: trackByUpgradeName;
          let i = index
        "
      >
        <img
          [src]="up.image || 'https://placehold.co/64x64/2a2a2a/f8f8f2?text=?'"
          [alt]="up.name"
          width="64"
          height="64"
        />
        <div class="card-details">
          <h3 class="upgrade-name" [title]="up.name">{{ up.name }}</h3>
          <p
            class="upgrade-info"
            [title]="
              'Qtd: ' +
              formatNumber(up.amount) +
              ' | +' +
              formatNumber(up.dps, true) +
              '/s'
            "
          >
            Qtd: {{ formatNumber(up.amount) }} | +{{
              formatNumber(up.dps, true)
            }}/s
          </p>
          <p
            class="upgrade-cost"
            [title]="
              'Custo: ' +
              formatNumber(getUpgradeCostForCurrentMode(up), false) +
              ' EssÃªncia'
            "
          >
            Custo:
            {{ formatNumber(getUpgradeCostForCurrentMode(up), false) }} EssÃªncia
          </p>
          <button
            class="action-button"
            (click)="buyUpgrade(i, currentPurchaseMode, 'auto')"
            [disabled]="!canAffordUpgrade(i, currentPurchaseMode, 'auto')"
          >
            Comprar
            {{
              currentPurchaseMode === "max" ? "MAX" : currentPurchaseMode + "x"
            }}
          </button>
        </div>
      </div>
    </div>
  </ng-container>
  <ng-template #noUpgradesAvailable>
    <div class="message-box">
      <p>
        Nenhuma manifestaÃ§Ã£o sombria Ã  vista. Continue coletando essÃªncia para
        despertÃ¡-las!
      </p>
    </div>
  </ng-template>

  <h2 class="section-title">âš¡ ManifestaÃ§Ãµes de CanalizaÃ§Ã£o</h2>
  <ng-container
    *ngIf="unlockedClickUpgrades().length > 0; else noClickUpgradesAvailable"
  >
    <div class="upgrades-grid">
      <div
        class="upgrade-card"
        *ngFor="
          let up of unlockedClickUpgrades();
          trackBy: trackByClickUpgradeName;
          let i = index
        "
      >
        <img
          [src]="up.image || 'https://placehold.co/64x64/2a2a2a/f8f8f2?text=?'"
          [alt]="up.name"
          width="64"
          height="64"
        />
        <div class="card-details">
          <h3 class="upgrade-name" [title]="up.name">{{ up.name }}</h3>
          <p
            class="upgrade-info"
            [title]="
              'Qtd: ' +
              formatNumber(up.amount) +
              ' | Multiplicador de Clique: x' +
              formatNumber(up.clickMultiplier, true)
            "
          >
            Qtd: {{ formatNumber(up.amount) }} | Multiplicador de Clique: x{{
              formatNumber(up.clickMultiplier, true)
            }}
          </p>
          <p
            class="upgrade-cost"
            [title]="
              'Custo: ' +
              formatNumber(getClickUpgradeCostForCurrentMode(up), false) +
              ' EssÃªncia'
            "
          >
            Custo:
            {{ formatNumber(getClickUpgradeCostForCurrentMode(up), false) }}
            EssÃªncia
          </p>
          <button
            class="action-button"
            (click)="buyUpgrade(i, currentPurchaseMode, 'click')"
            [disabled]="!canAffordUpgrade(i, currentPurchaseMode, 'click')"
          >
            Comprar
            {{
              currentPurchaseMode === "max" ? "MAX" : currentPurchaseMode + "x"
            }}
          </button>
        </div>
      </div>
    </div>
  </ng-container>
  <ng-template #noClickUpgradesAvailable>
    <div class="message-box">
      <p>
        Nenhuma manifestaÃ§Ã£o de canalizaÃ§Ã£o Ã  vista. FortaleÃ§a sua mente para
        despertÃ¡-las!
      </p>
    </div>
  </ng-template>

  <h2 class="section-title">ğŸ† RevelaÃ§Ãµes Sombrias</h2>
  <ul class="trophies-list">
    <li
      *ngFor="let t of trophies(); trackBy: trackByTrophyTitle"
      [class.earned]="t.earned"
      [class.locked]="!t.earned"
      class="trophy-item"
      (click)="viewTrophyDetails(t)"
    >
      <span class="trophy-icon">{{ t.icon }}</span>
      <span class="trophy-title">{{ t.title }}</span>
    </li>
  </ul>
</div>

<div class="modal-overlay" *ngIf="showTrophyModal()">
  <div class="modal-content">
    <h3 class="modal-title">
      {{ unlockedTrophy()?.icon }} {{ unlockedTrophy()?.title }}
    </h3>
    <p class="modal-description">{{ unlockedTrophy()?.description }}</p>
    <button class="modal-close-button" (click)="closeModal()">Fechar</button>
  </div>
</div>

<div class="modal-overlay" *ngIf="showImportModal">
  <div class="modal-content">
    <h3 class="modal-title">Importar Save</h3>
    <p class="modal-description">Cole seu save aqui:</p>
    <textarea class="save-textarea" [(ngModel)]="importedSaveData"></textarea>
    <div class="modal-actions">
      <button class="secondary-button" (click)="importSave()">Importar</button>
      <button class="secondary-button" (click)="showImportModal = false">
        Cancelar
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showExportTextModal">
  <div class="modal-content">
    <h3 class="modal-title">Seu CÃ³digo de Save</h3>
    <p class="modal-description">
      Copie o texto abaixo e salve-o em um local seguro:
    </p>
    <textarea
      class="save-textarea"
      [value]="exportedSaveText"
      readonly
    ></textarea>
    <div class="modal-actions">
      <button class="secondary-button" (click)="copyExportedSaveText()">
        Copiar para Ãrea de TransferÃªncia
      </button>
      <button class="secondary-button" (click)="showExportTextModal = false">
        Fechar
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showTrophyDetailsModal">
  <div class="modal-content">
    <h3 class="modal-title">
      {{ selectedTrophy?.icon }} {{ selectedTrophy?.title }}
    </h3>
    <p class="modal-description">{{ selectedTrophy?.description }}</p>
    <button class="modal-close-button" (click)="closeTrophyDetailsModal()">
      Fechar
    </button>
  </div>
</div>
